#!/bin/bash

# auto-vuln-scan.sh v1.1 - Fixed for Kali 2025+
# Enrique Moreno - AD Red Teaming Labs

set -euo pipefail

TARGETS_FILE=""
OUTPUT_DIR="../reports/raw"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
FINAL_DIR="$OUTPUT_DIR/$TIMESTAMP"
mkdir -p "$FINAL_DIR"

while getopts t:o: flag; do
    case "${flag}" in
        t) TARGETS_FILE=${OPTARG};;
        o) OUTPUT_DIR=${OPTARG}; FINAL_DIR="$OUTPUT_DIR/$TIMESTAMP"; mkdir -p "$FINAL_DIR";;
    esac
done

[ -z "$TARGETS_FILE" ] && echo "Usage: $0 -t config/targets.txt [-o reports/raw]" && exit 1
[ ! -f "$TARGETS_FILE" ] && echo "[-] Targets file not found: $TARGETS_FILE" && exit 1

echo "[+] Starting automated vulnerability assessment - $TIMESTAMP"
echo "[+] Targets: $TARGETS_FILE"
echo "[+] Output directory: $FINAL_DIR"
echo

# Step 1+2: Hosts alive + Nmap full scan
echo "[1/5] Discovering live hosts..."
nmap -sn -iL "$TARGETS_FILE" -oG "$FINAL_DIR/hosts_alive.txt" --open | tee "$FINAL_DIR/hosts_alive_verbose.txt"

echo "[2/5] Running full Nmap scan (-sV -sC --script vuln)..."
nmap -sV -sC --script="vuln" -iL "$TARGETS_FILE" -oX "$FINAL_DIR/nmap_scan.xml" -oN "$FINAL_DIR/nmap_scan.txt" -Pn

# Step 3: Searchsploit parsing mejorado
echo "[3/5] Searching exploits with searchsploit..."
grep -E "(open|VERSION)" "$FINAL_DIR/nmap_scan.txt" | grep -v "Not shown" | awk -F' ' '{print $5,$6,$7}' | sort -u > "$FINAL_DIR/services_detected.txt"

echo '{' > "$FINAL_DIR/searchsploit.json"
first=1
while read -r service; do
    [ "$first" -eq 1 ] && first=0 || echo ',' >> "$FINAL_DIR/searchsploit.json"
    echo "  \"$service\": " >> "$FINAL_DIR/searchsploit.json"
    searchsploit "$service" -j --color | sed 's/^/    /' >> "$FINAL_DIR/searchsploit.json" 2>/dev/null || echo "    \"No exploits found\"" >> "$FINAL_DIR/searchsploit.json"
done < "$FINAL_DIR/services_detected.txt"
echo '}' >> "$FINAL_DIR/searchsploit.json"

# Step 4: Web discovery & scanning
echo "[4/5] Discovering HTTP/S services with httpx..."
httpx -list "$FINAL_DIR/hosts_alive.txt" -ports 80,443,8080,5357,5985,5986 -title -status-code -silent -o "$FINAL_DIR/live_web.txt" || echo "[-] No web services found or httpx failed"

if [ -s "$FINAL_DIR/live_web.txt" ]; then
    echo "[5/5] Running Nuclei (critical + high only)..."
    nuclei -l "$FINAL_DIR/live_web.txt" -severity critical,high -o "$FINAL_DIR/nuclei_critical_high.txt" -silent
    nuclei -l "$FINAL_DIR/live_web.txt" -severity medium -o "$FINAL_DIR/nuclei_medium.txt" -silent
else
    echo "[!] No HTTP/S services found for Nuclei scanning"
fi

# Generate final curated report (we will fill this manually later)
cat > "../reports/findings-report.md" << 'EOF'
# Vulnerability Assessment Findings - Automated Scan
*Scan executed on $(date)*

| # | Vulnerability                          | Severity     | Evidence / PoC                          | Recommendation                              | Target       |
|---|----------------------------------------|--------------|-----------------------------------------|---------------------------------------------|--------------|
EOF

echo "Scan completed successfully!"
echo "→ Raw results: $FINAL_DIR/"
echo "→ Curated report: ../reports/findings-report.md (ready for you to fill with real findings)"