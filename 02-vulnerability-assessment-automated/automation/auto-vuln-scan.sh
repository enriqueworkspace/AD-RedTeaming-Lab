#!/bin/bash

# auto-vuln-scan.sh: Automated vulnerability assessment wrapper for lab
# Usage: ./auto-vuln-scan.sh -t targets.txt -o output_dir
# Dependencies: nmap, searchsploit, httpx, nuclei (install via apt on Kali if needed)
# Disclaimer: For lab environments only. No exploitation.

# Parse arguments
while getopts t:o: opt; do
  case $opt in
    t) TARGETS_FILE=$OPTARG ;;
    o) OUTPUT_DIR=$OPTARG ;;
    *) echo "Usage: $0 -t targets.txt -o reports/" ; exit 1 ;;
  esac
done

# Default output dir
OUTPUT_DIR=${OUTPUT_DIR:-"../reports/raw"}

# Create output dir if needed
mkdir -p "$OUTPUT_DIR"

# Step 1: Read targets
if [ ! -f "$TARGETS_FILE" ]; then
  echo "Targets file not found: $TARGETS_FILE"
  exit 1
fi
TARGETS=$(cat "$TARGETS_FILE")

# Step 2: Validation (ping sweep optional; use -Pn for no ping)
echo "Validating targets..."
alive_hosts="$OUTPUT_DIR/alive_hosts.txt"
nmap -sn $TARGETS -oN "$alive_hosts"  # Or skip with -Pn in later scans

# Step 3: Nmap discovery + versioning
echo "Running Nmap scan..."
nmap_output="$OUTPUT_DIR/nmap_scan.xml"
nmap -sV -sC --script vuln -oX "$nmap_output" -oN "$OUTPUT_DIR/nmap_scan.txt" $TARGETS -Pn

# Step 4: Parse services/versions and feed searchsploit
echo "Parsing Nmap for searchsploit..."
# Simple grep for services/versions (improve as needed)
services=$(grep "open" "$OUTPUT_DIR/nmap_scan.txt" | awk '{print $5 " " $6 " " $7}' | sort -u)
searchsploit_output="$OUTPUT_DIR/searchsploit.json"
> "$searchsploit_output"  # Clear file
for service in $services; do
  searchsploit "$service" --json >> "$searchsploit_output"
done

# Step 5: Web scanning
echo "Running web discovery and scanning..."
live_web="$OUTPUT_DIR/live_web.txt"
httpx -l "$alive_hosts" -silent > "$live_web"  # Assumes alive_hosts has IPs
nuclei_output="$OUTPUT_DIR/nuclei.txt"
nuclei -l "$live_web" -t cves/ -t misconfigurations/ -severity critical,high -o "$nuclei_output"
# Alternative: nikto -h $(cat "$live_web") -o "$OUTPUT_DIR/nikto.txt" -Tuning x

# Step 6: Generate consolidated report (basic Markdown table)
echo "Generating findings report..."
report="../reports/findings-report.md"
echo "| # | Vulnerabilidad | Severidad (CVSS v3.x) | Evidencia / PoC | RecomendaciÃ³n |" > "$report"
echo "|---|---------------|-----------------------|-----------------|---------------|" >> "$report"
# Placeholder rows (populate manually or improve parsing)
echo "| 1 | Example Vuln | 9.8 (Critical) | Nmap output | Patch it |" >> "$report"
# TODO: Add real parsing from outputs (e.g., using grep/jq)

# Step 7: Timestamp raw outputs
timestamp=$(date +%Y%m%d_%H%M%S)
mv "$OUTPUT_DIR"/* "$OUTPUT_DIR/${timestamp}_"

echo "Scan complete. Check $report and raw outputs in $OUTPUT_DIR."