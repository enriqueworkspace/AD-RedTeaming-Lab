#!/bin/bash

# auto-vuln-scan.sh v1.2
# Automated vulnerability assessment wrapper for lab environments
# Only use in isolated lab setups — never against production systems

set -euo pipefail

# Default values
TARGETS_FILE=""
OUTPUT_BASE="../reports/raw"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
OUTPUT_DIR="$OUTPUT_BASE/$TIMESTAMP"
mkdir -p "$OUTPUT_DIR"

# Parse arguments
while getopts t:o: flag; do
    case "${flag}" in
        t) TARGETS_FILE=${OPTARG};;
        o) OUTPUT_BASE=${OPTARG}; OUTPUT_DIR="$OUTPUT_BASE/$TIMESTAMP"; mkdir -p "$OUTPUT_DIR";;
    esac
done

# Check required argument
if [ -z "$TARGETS_FILE" ] || [ ! -f "$TARGETS_FILE" ]; then
    echo "Usage: $0 -t config/targets.txt [-o reports/raw]"
    echo "Error: targets file not specified or not found"
    exit 1
fi

echo "[+] Starting automated vulnerability assessment"
echo "[+] Timestamp:   $TIMESTAMP"
echo "[+] Targets file: $TARGETS_FILE"
echo "[+] Output dir:   $OUTPUT_DIR"
echo

# ────────────────────────────────────────────────
# 1. Discover live hosts
# ────────────────────────────────────────────────
echo "[1/5] Discovering live hosts..."
nmap -sn -iL "$TARGETS_FILE" -oG "$OUTPUT_DIR/hosts_alive.grep" --open | tee "$OUTPUT_DIR/hosts_alive_verbose.txt"

# Extract only up hosts (IP only)
grep "Status: Up" "$OUTPUT_DIR/hosts_alive.grep" | awk '{print $2}' > "$OUTPUT_DIR/hosts_alive.txt"


# ────────────────────────────────────────────────
# 2. Full Nmap scan with version + default scripts + vuln category
# ────────────────────────────────────────────────
echo "[2/5] Running detailed Nmap scan (-sV -sC --script vuln)..."
nmap -sV -sC --script="vuln" \
    -iL "$TARGETS_FILE" \
    -oX "$OUTPUT_DIR/nmap_scan.xml" \
    -oN "$OUTPUT_DIR/nmap_scan.txt" \
    -Pn \
    | tee "$OUTPUT_DIR/nmap_scan_log.txt"


# ────────────────────────────────────────────────
# 3. Searchsploit lookup (cleaner version)
# ────────────────────────────────────────────────
echo "[3/5] Searching exploits with searchsploit..."
# Extract service/version lines more reliably
grep 'open' "$OUTPUT_DIR/nmap_scan.txt" | \
    grep -v '^Not shown' | \
    grep -E '^[0-9]+/tcp' | \
    awk '{for(i=5;i<=NF;i++) printf "%s ", $i; print ""}' | \
    sed 's/^[ \t]*//;s/[ \t]*$//;s/  */ /g' | \
    grep -v '^$' | sort -u > "$OUTPUT_DIR/services_detected.txt"

if [ -s "$OUTPUT_DIR/services_detected.txt" ]; then
    echo "Found services to search:"
    cat "$OUTPUT_DIR/services_detected.txt"
    
    echo '{' > "$OUTPUT_DIR/searchsploit.json"
    first=1
    while IFS= read -r service; do
        [ -z "$service" ] && continue
        [ "$first" -eq 1 ] && first=0 || echo ',' >> "$OUTPUT_DIR/searchsploit.json"
        echo "  \"$service\": " >> "$OUTPUT_DIR/searchsploit.json"
        searchsploit "$service" -j --color 2>/dev/null >> "$OUTPUT_DIR/searchsploit.json" || \
            echo "    \"No exploits found\"" >> "$OUTPUT_DIR/searchsploit.json"
    done < "$OUTPUT_DIR/services_detected.txt"
    echo '}' >> "$OUTPUT_DIR/searchsploit.json"
else
    echo "[!] No services detected for searchsploit"
    echo "{}" > "$OUTPUT_DIR/searchsploit.json"
fi


# ────────────────────────────────────────────────
# 4. HTTP/S discovery with httpx
# ────────────────────────────────────────────────
echo "[4/5] Discovering HTTP/S services with httpx..."
httpx -list "$OUTPUT_DIR/hosts_alive.txt" \
    -ports 80,443,8080,5985,5986,5357 \
    -title -status-code -tech-detect -silent \
    -o "$OUTPUT_DIR/live_web.txt" || echo "[-] httpx failed or no web services found"


# ────────────────────────────────────────────────
# 5. Run Nuclei on discovered web services (critical + high only)
# ────────────────────────────────────────────────
if [ -s "$OUTPUT_DIR/live_web.txt" ]; then
    echo "[5/5] Running Nuclei scan (critical + high)..."
    nuclei -l "$OUTPUT_DIR/live_web.txt" \
        -severity critical,high \
        -o "$OUTPUT_DIR/nuclei_critical_high.txt" \
        -silent || echo "[-] Nuclei failed"
    
    echo "[5/5] Running Nuclei scan (medium)..."
    nuclei -l "$OUTPUT_DIR/live_web.txt" \
        -severity medium \
        -o "$OUTPUT_DIR/nuclei_medium.txt" \
        -silent || echo "[-] Nuclei failed"
else
    echo "[!] No live web services found — skipping Nuclei"
fi


# ────────────────────────────────────────────────
# Final message
# ────────────────────────────────────────────────
echo
echo "Scan completed!"
echo "→ All raw results saved in: $OUTPUT_DIR/"
echo "→ Curated report location: ../reports/findings-report.md"
echo "→ Next step: review outputs and manually fill the findings table"
echo
